{% extends "base.html" %}

{% block title %}多疾病关联分析 - 疾病预测与大数据分析系统{% endblock %}

{% block meta_description %}分析中风、心脏病和肝硬化三种疾病之间的关联性，评估共同风险因素和并发风险。{% endblock %}

{% block content %}
    <div class="container mt-4">
    <h1 class="text-center mb-5 animated-title white-heading">多疾病关联分析</h1>

        <div class="row mb-4">
            <div class="col-12 slide-section">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h3 class="card-title mb-0">疾病间关联概述</h3>
                    </div>
                    <div class="card-body">
                        <p class="lead">中风、心脏病和肝硬化这三种严重疾病存在密切的关联。通过分析共同风险因素、并发症和潜在的病理机制，可以更全面地了解患者的健康状况和风险。</p>
                        <div class="row mt-4">
                            <div class="col-md-4">
                                <div class="text-center mb-3">
                                    <i class="fas fa-link fa-3x text-primary"></i>
                                    <h4 class="mt-2">共病关系</h4>
                                </div>
                                <p>这三种疾病常常同时出现或相继发生，称为共病现象。例如，心脏病患者中风风险高出2-4倍，而肝功能障碍也可能加重心脑血管疾病风险。</p>
                            </div>
                            <div class="col-md-4">
                                <div class="text-center mb-3">
                                    <i class="fas fa-exclamation-triangle fa-3x text-warning"></i>
                                    <h4 class="mt-2">共同风险因素</h4>
                                </div>
                                <p>高血压、糖尿病、肥胖、不健康饮食和缺乏运动等是这三种疾病的共同风险因素，同时影响多个器官系统健康。</p>
                            </div>
                            <div class="col-md-4">
                                <div class="text-center mb-3">
                                    <i class="fas fa-heartbeat fa-3x text-danger"></i>
                                    <h4 class="mt-2">协同病理机制</h4>
                                </div>
                                <p>炎症反应、氧化应激和内皮功能障碍等机制在这三种疾病的发生发展过程中均发挥重要作用，形成复杂的相互作用网络。</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-6 slide-section">
                <div class="card h-100">
                    <div class="card-header bg-primary text-white">
                        <h3 class="card-title mb-0">性别与疾病关系对比</h3>
                    </div>
                    <div class="card-body text-center">
                        {% if 'gender_disease_comparison' in charts %}
                        <img src="/figures/gender_disease_comparison.png" alt="性别与疾病风险关系" class="img-fluid">
                        {% else %}
                        <div class="chart-container" style="position: relative; height:250px; width:100%">
                                <canvas id="genderDiseaseChart"></canvas>
                            </div>
                        {% endif %}
                </div>
                </div>
            </div>
            <div class="col-md-6 slide-section">
                <div class="card h-100">
                    <div class="card-header bg-primary text-white">
                        <h3 class="card-title mb-0">年龄分布比较</h3>
                    </div>
                    <div class="card-body text-center">
                        {% if 'disease_age_comparison' in charts %}
                        <img src="/figures/disease_age_comparison.png" alt="三种疾病年龄分布" class="img-fluid">
                        {% else %}
                        <div class="chart-container" style="position: relative; height:250px; width:100%">
                            <canvas id="ageDistributionChart"></canvas>
                            </div>
                        {% endif %}
                        <p class="mt-3">小提琴图展示了三种疾病患者的年龄分布特点和差异，包括中位数、四分位数和异常值。</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 新增年龄与疾病关系对比区域 -->
        <div class="row mb-4">
            <div class="col-12 slide-section">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h3 class="card-title mb-0">年龄与疾病发病率关系</h3>
                    </div>
                    <div class="card-body text-center">
                        {% if 'disease_rate_by_age' in charts %}
                        <img src="/figures/disease_rate_by_age.png" alt="年龄与疾病发病率关系" class="img-fluid">
                        {% else %}
                        <div class="chart-container" style="position: relative; height:300px; width:100%">
                            <canvas id="diseaseAgeChart"></canvas>
                        </div>
                        {% endif %}
                        <p class="mt-3">该图展示了不同年龄段人群中三种疾病的发病率变化趋势，反映了年龄与疾病风险之间的关系。</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4 slide-section">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h3 class="card-title mb-0">共病风险因素分析</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h4 class="text-center mb-3">关键共病风险因素</h4>
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>风险因素</th>
                                                <th>中风</th>
                                                <th>心脏病</th>
                                                <th>肝硬化</th>
                                                <th>综合风险系数</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>高血压</td>
                                                <td class="text-danger"><i class="fas fa-exclamation-circle"></i> 高</td>
                                                <td class="text-danger"><i class="fas fa-exclamation-circle"></i> 高</td>
                                                <td class="text-warning"><i class="fas fa-exclamation-triangle"></i> 中</td>
                                                <td class="text-danger">4.5</td>
                                            </tr>
                                            <tr>
                                                <td>糖尿病</td>
                                                <td class="text-danger"><i class="fas fa-exclamation-circle"></i> 高</td>
                                                <td class="text-danger"><i class="fas fa-exclamation-circle"></i> 高</td>
                                                <td class="text-warning"><i class="fas fa-exclamation-triangle"></i> 中</td>
                                                <td class="text-danger">4.2</td>
                                            </tr>
                                            <tr>
                                                <td>肥胖</td>
                                                <td class="text-warning"><i class="fas fa-exclamation-triangle"></i> 中</td>
                                                <td class="text-danger"><i class="fas fa-exclamation-circle"></i> 高</td>
                                                <td class="text-warning"><i class="fas fa-exclamation-triangle"></i> 中</td>
                                                <td class="text-warning">3.8</td>
                                            </tr>
                                            <tr>
                                                <td>吸烟</td>
                                                <td class="text-danger"><i class="fas fa-exclamation-circle"></i> 高</td>
                                                <td class="text-danger"><i class="fas fa-exclamation-circle"></i> 高</td>
                                                <td class="text-warning"><i class="fas fa-exclamation-triangle"></i> 中</td>
                                                <td class="text-danger">4.3</td>
                                            </tr>
                                            <tr>
                                                <td>酒精过量</td>
                                                <td class="text-warning"><i class="fas fa-exclamation-triangle"></i> 中</td>
                                                <td class="text-warning"><i class="fas fa-exclamation-triangle"></i> 中</td>
                                                <td class="text-danger"><i class="fas fa-exclamation-circle"></i> 高</td>
                                                <td class="text-warning">3.7</td>
                                            </tr>
                                            <tr>
                                                <td>高脂血症</td>
                                                <td class="text-warning"><i class="fas fa-exclamation-triangle"></i> 中</td>
                                                <td class="text-danger"><i class="fas fa-exclamation-circle"></i> 高</td>
                                                <td class="text-success"><i class="fas fa-check-circle"></i> 低</td>
                                                <td class="text-warning">3.0</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="col-md-6">
                            <div class="chart-container" style="position: relative; height:300px; width:100%">
                                    <canvas id="riskFactorChart"></canvas>
                            </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4 slide-section">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h3 class="card-title mb-0">多病预测模型与综合风险评估</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h4 class="text-center mb-3">综合风险评估方法</h4>
                                <p>本系统采用多目标学习方法，构建了一个能同时预测三种疾病风险的综合模型。该模型考虑了各疾病之间的相互作用，显著提高了预测准确性。</p>
                                <div class="methodology-steps">
                                    <div class="step">
                                        <div class="step-number">1</div>
                                        <div class="step-content">
                                            <h5>特征整合</h5>
                                            <p>融合三个疾病数据集的共同特征，创建统一的特征表示。</p>
                                        </div>
                                    </div>
                                    <div class="step">
                                        <div class="step-number">2</div>
                                        <div class="step-content">
                                            <h5>多任务学习</h5>
                                            <p>模型底层共享参数，上层针对各疾病分别优化，捕获疾病间关联。</p>
                                        </div>
                                    </div>
                                    <div class="step">
                                        <div class="step-number">3</div>
                                        <div class="step-content">
                                            <h5>协同正则化</h5>
                                            <p>应用特殊的正则化技术，促使模型学习疾病间的共病模式。</p>
                                        </div>
                                    </div>
                                    <div class="step">
                                        <div class="step-number">4</div>
                                        <div class="step-content">
                                            <h5>综合风险评分</h5>
                                            <p>基于多维度预测结果，计算患者的综合健康风险指数。</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h4 class="text-center mb-3">综合模型性能对比</h4>
                            <div class="chart-container" style="position: relative; height:300px; width:100%">
                                    <canvas id="multiDiseaseModelChart"></canvas>
                                </div>
                                <div class="mt-3">
                                    <p class="text-center"><strong>结论：</strong> 综合模型在所有三种疾病的预测中均优于单独模型，表明考虑疾病间关联可以提高预测准确性。</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4 slide-section">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h3 class="card-title mb-0">预防建议与健康管理</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="recommendation-card">
                                    <div class="recommendation-icon">
                                        <i class="fas fa-utensils"></i>
                                    </div>
                                    <h4>健康饮食</h4>
                                    <ul>
                                        <li>控制盐分摄入，每日不超过5g</li>
                                        <li>增加蔬果摄入，每日至少5份</li>
                                        <li>选择健康脂肪，避免反式脂肪</li>
                                        <li>控制总热量，保持健康体重</li>
                                        <li>限制酒精摄入，男性每日不超过2杯，女性不超过1杯</li>
                                    </ul>
                                    <div class="benefit-text">可同时降低三种疾病风险达25-40%</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="recommendation-card">
                                    <div class="recommendation-icon">
                                        <i class="fas fa-running"></i>
                                    </div>
                                    <h4>规律运动</h4>
                                    <ul>
                                        <li>中等强度有氧运动，每周至少150分钟</li>
                                        <li>肌肉强化训练，每周至少2次</li>
                                        <li>减少久坐时间，每小时起身活动</li>
                                        <li>根据个人情况逐步增加运动量</li>
                                        <li>结合有氧运动和力量训练</li>
                                    </ul>
                                    <div class="benefit-text">可降低心脑血管疾病风险约30%，肝病风险约20%</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="recommendation-card">
                                    <div class="recommendation-icon">
                                        <i class="fas fa-stethoscope"></i>
                                    </div>
                                    <h4>健康监测</h4>
                                    <ul>
                                        <li>定期测量血压，控制在130/80mmHg以下</li>
                                        <li>定期检查血糖，空腹血糖<6.1mmol/L</li>
                                        <li>监测血脂水平，LDL胆固醇<3.4mmol/L</li>
                                        <li>定期肝功能检查，特别是有风险因素者</li>
                                        <li>遵医嘱服药，不自行调整药物</li>
                                    </ul>
                                    <div class="benefit-text">早期干预可将严重疾病风险降低50%以上</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_scripts %}
<!-- 使用defer属性延迟加载Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js" defer></script>
<script>
    // 等待页面和Chart.js完全加载后再初始化图表
    document.addEventListener('DOMContentLoaded', function() {
        // 移除页面顶部的"年龄与多种疾病的关系"标题
        const pageTitleH1 = document.querySelector('.hero-section h1');
        if (pageTitleH1 && pageTitleH1.textContent.includes('年龄与多种疾病的关系')) {
            pageTitleH1.textContent = '多疾病关联分析';
        }
        
        // 等待Chart.js加载完成
        function initCharts() {
            if (typeof Chart === 'undefined') {
                // 如果Chart.js尚未加载，等待100毫秒后重试
                setTimeout(initCharts, 100);
                return;
            }
            
            try {
                // 初始化性别-疾病关系图表
                const genderChart = document.getElementById('genderDiseaseChart');
                if (genderChart) {
                    new Chart(genderChart, {
                        type: 'bar',
                        data: {
                            labels: ['女性', '男性'],
                            datasets: [
                                {
                                    label: '中风风险',
                                    data: [3.8, 4.2],
                                    backgroundColor: 'rgba(54, 162, 235, 0.7)'
                                },
                                {
                                    label: '心脏病风险',
                                    data: [42.9, 57.1],
                                    backgroundColor: 'rgba(255, 99, 132, 0.7)'
                                },
                                {
                                    label: '肝硬化风险',
                                    data: [35.2, 64.8],
                                    backgroundColor: 'rgba(255, 205, 86, 0.7)'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: '患病率 (%)'
                                    }
                                }
                            },
                            plugins: {
                                title: {
                                    display: true,
                                    text: '不同性别的疾病患病率对比'
                                }
                            }
                        }
                    });
                    console.log('性别-疾病关系图表初始化成功');
                }
                
                // 初始化风险因素雷达图
                const riskChart = document.getElementById('riskFactorChart');
                if (riskChart) {
                    new Chart(riskChart, {
                        type: 'radar',
                        data: {
                            labels: ['高血压', '糖尿病', '肥胖', '吸烟', '酒精过量', '高脂血症'],
                            datasets: [
                                {
                                    label: '中风',
                                    data: [5, 4.5, 3.5, 4.8, 3, 3.2],
                                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                    borderColor: 'rgba(54, 162, 235, 1)',
                                    pointBackgroundColor: 'rgba(54, 162, 235, 1)'
                                },
                                {
                                    label: '心脏病',
                                    data: [5, 4.5, 4.5, 4.8, 3, 5],
                                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                    borderColor: 'rgba(255, 99, 132, 1)',
                                    pointBackgroundColor: 'rgba(255, 99, 132, 1)'
                                },
                                {
                                    label: '肝硬化',
                                    data: [3, 3, 3.5, 3, 5, 2],
                                    backgroundColor: 'rgba(255, 205, 86, 0.2)',
                                    borderColor: 'rgba(255, 205, 86, 1)',
                                    pointBackgroundColor: 'rgba(255, 205, 86, 1)'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            elements: {
                                line: {
                                    borderWidth: 2
                                }
                            },
                            scales: {
                                r: {
                                    angleLines: {
                                        display: true
                                    },
                                    suggestedMin: 0,
                                    suggestedMax: 5
                                }
                            },
                            plugins: {
                                title: {
                                    display: true,
                                    text: '风险因素对三种疾病的影响程度'
                                }
                            }
                        }
                    });
                    console.log('风险因素雷达图初始化成功');
                }
                
                // 初始化多疾病模型对比图表
                const modelChart = document.getElementById('multiDiseaseModelChart');
                if (modelChart) {
                    new Chart(modelChart, {
                        type: 'bar',
                        data: {
                            labels: ['中风单独模型', '心脏病单独模型', '肝硬化单独模型', '多疾病综合模型'],
                            datasets: [
                                {
                                    label: '中风预测准确率',
                                    data: [92.3, null, null, 94.1],
                                    backgroundColor: 'rgba(54, 162, 235, 0.7)'
                                },
                                {
                                    label: '心脏病预测准确率',
                                    data: [null, 88.5, null, 90.7],
                                    backgroundColor: 'rgba(255, 99, 132, 0.7)'
                                },
                                {
                                    label: '肝硬化预测准确率',
                                    data: [null, null, 85.2, 87.8],
                                    backgroundColor: 'rgba(255, 205, 86, 0.7)'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100,
                                    title: {
                                        display: true,
                                        text: '准确率 (%)'
                                    }
                                }
                            },
                            plugins: {
                                title: {
                                    display: true,
                                    text: '单疾病模型与多疾病综合模型性能对比'
                                }
                            }
                        }
                    });
                    console.log('多疾病模型对比图表初始化成功');
                }
                
                // 初始化疾病年龄分布图
                const ageChart = document.getElementById('ageDistributionChart');
                if (ageChart) {
                    new Chart(ageChart, {
                        type: 'bar',
                        data: {
                            labels: ['<40', '40-50', '50-60', '60-70', '70-80', '>80'],
                            datasets: [
                                {
                                    label: '中风',
                                    data: [5, 12, 28, 35, 45, 52],
                                    backgroundColor: 'rgba(54, 162, 235, 0.7)'
                                },
                                {
                                    label: '心脏病',
                                    data: [8, 15, 32, 42, 48, 45],
                                    backgroundColor: 'rgba(255, 99, 132, 0.7)'
                                },
                                {
                                    label: '肝硬化',
                                    data: [10, 25, 38, 35, 30, 22],
                                    backgroundColor: 'rgba(255, 205, 86, 0.7)'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: '患病率 (%)'
                                    }
                                }
                            },
                            plugins: {
                                title: {
                                    display: true,
                                    text: '各年龄段疾病分布'
                                }
                            }
                        }
                    });
                    console.log('疾病年龄分布图初始化成功');
                }
                
                // 初始化疾病年龄关系图（仅当静态图像不存在时）
                const diseaseAgeChart = document.getElementById('diseaseAgeChart');
                if (diseaseAgeChart) {
                    new Chart(diseaseAgeChart, {
                        type: 'line',
                        data: {
                            labels: ['20-30', '30-40', '40-50', '50-60', '60-70', '70-80', '80+'],
                            datasets: [
                                {
                                    label: '中风发病率',
                                    data: [2, 5, 12, 25, 38, 45, 52],
                                    borderColor: 'rgba(54, 162, 235, 1)',
                                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                                    fill: true,
                                    tension: 0.3
                                },
                                {
                                    label: '心脏病发病率',
                                    data: [3, 8, 15, 30, 42, 48, 45],
                                    borderColor: 'rgba(255, 99, 132, 1)',
                                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                                    fill: true,
                                    tension: 0.3
                                },
                                {
                                    label: '肝硬化发病率',
                                    data: [4, 10, 25, 38, 35, 30, 22],
                                    borderColor: 'rgba(255, 205, 86, 1)',
                                    backgroundColor: 'rgba(255, 205, 86, 0.1)',
                                    fill: true,
                                    tension: 0.3
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: '发病率 (%)'
                                    }
                                }
                            },
                            plugins: {
                                title: {
                                    display: true,
                                    text: '年龄与疾病发病率关系'
                                }
                            }
                        }
                    });
                    console.log('疾病年龄关系图初始化成功');
                }
            } catch (error) {
                console.error('初始化图表时出错:', error);
            }
        }
        
        // 启动图表初始化
        initCharts();
    });
</script>
{% endblock %} 