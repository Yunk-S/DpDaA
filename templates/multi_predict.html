{% extends "base.html" %}

{% block title %}多疾病风险联合预测 - 疾病预测与大数据分析系统{% endblock %}

{% block meta_description %}预测同时患有中风、心脏病和肝硬化的风险概率，基于多维健康指标评估综合疾病风险。{% endblock %}

{% block extra_head %}
<style>
    .prediction-form {
        background-color: #fff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
        transition: all 0.3s ease;
    }
    .prediction-form:hover {
        box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
    }
    .result-card {
        display: none;
        margin-top: 20px;
        margin-bottom: 30px;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        background-color: rgba(0, 0, 0, 0.6);
        color: #ffffff;
    }
    .result-card.show {
        transform: scale(1.02);
    }
    .high-risk {
        background-color: rgba(220, 53, 69, 0.7);
        border-color: #f5c6cb;
        color: #ffffff;
    }
    .moderate-risk {
        background-color: rgba(255, 193, 7, 0.7);
        border-color: #ffeeba;
        color: #ffffff;
    }
    .low-risk {
        background-color: rgba(40, 167, 69, 0.7);
        border-color: #c3e6cb;
        color: #ffffff;
    }
    .form-label {
        font-weight: 500;
    }
    .hero-text-enhanced {
        color: #ffffff;
        text-shadow: 0 0 10px rgba(0, 0, 0, 0.8), 0 0 20px rgba(0, 0, 0, 0.6);
        font-weight: 600;
        background-color: rgba(0, 0, 0, 0.4);
        padding: 10px 20px;
        border-radius: 8px;
        display: inline-block;
        margin-bottom: 15px;
    }
    .probability-item {
        padding: 10px;
        border-radius: 5px;
        margin: 5px 0;
        transition: all 0.3s ease;
        background-color: rgba(255, 255, 255, 0.1);
    }
    .probability-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        background-color: rgba(255, 255, 255, 0.2);
    }
    .probability-bar {
        height: 25px;
        border-radius: 5px;
        margin-top: 5px;
        background-color: rgba(0, 0, 0, 0.3);
    }
    .chart-container {
        height: 300px;
        margin-top: 20px;
        background-color: rgba(255, 255, 255, 0.1);
        padding: 10px;
        border-radius: 8px;
    }
    .form-section {
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 20px;
    }
    .form-section h4 {
        margin-top: 0;
        color: #0d6efd;
    }
    .disease-icon {
        font-size: 1.2em;
        margin-right: 10px;
    }
    .combo-item {
        font-weight: bold;
    }
    .alert-info {
        background-color: rgba(23, 162, 184, 0.7);
        color: white;
        border: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4 fade-in">
    <h1 class="text-center mb-4 animated-title white-heading">多疾病风险联合预测</h1>
    <p class="lead text-center hero-text-enhanced">输入您的健康指标，系统将评估您同时患有多种疾病的综合风险</p>

    <!-- 预测结果显示区域 -->
    <div id="prediction-result" class="result-card fade-in-section">
        <h2 class="text-center mb-4">预测结果</h2>
        <div id="result-content"></div>
    </div>

    <!-- 多疾病预测表单 -->
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="prediction-form fade-in-section is-visible">
                <h3 class="text-center mb-4">综合健康风险评估</h3>
                <form id="multi-disease-form" class="prediction-form-element">
                    <input type="hidden" name="prediction_type" value="multi">
                    
                    <!-- 基本信息 -->
                    <div class="form-section">
                        <h4><i class="fas fa-user"></i> 基本信息</h4>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="age" class="form-label">年龄</label>
                                <input type="number" class="form-control" id="age" name="age" min="1" max="120" required>
                            </div>
                            <div class="col-md-4">
                                <label for="gender" class="form-label">性别</label>
                                <select class="form-select" id="gender" name="gender" required>
                                    <option value="">请选择</option>
                                    <option value="Male">男</option>
                                    <option value="Female">女</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="bmi" class="form-label">体重指数 (BMI)</label>
                                <input type="number" class="form-control" id="bmi" name="bmi" min="10" max="60" step="0.1" required>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 心血管相关指标 -->
                    <div class="form-section">
                        <h4><i class="fas fa-heartbeat"></i> 心血管指标</h4>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="hypertension" class="form-label">高血压</label>
                                <select class="form-select" id="hypertension" name="hypertension" required>
                                    <option value="">请选择</option>
                                    <option value="0">否</option>
                                    <option value="1">是</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="heart_disease" class="form-label">心脏病史</label>
                                <select class="form-select" id="heart_disease" name="heart_disease" required>
                                    <option value="">请选择</option>
                                    <option value="0">否</option>
                                    <option value="1">是</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="avg_glucose_level" class="form-label">平均血糖水平 (mg/dL)</label>
                                <input type="number" class="form-control" id="avg_glucose_level" name="avg_glucose_level" min="50" max="300" step="0.1" required>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="cholesterol" class="form-label">胆固醇 (mg/dL)</label>
                                <input type="number" class="form-control" id="cholesterol" name="cholesterol" min="100" max="600" required>
                            </div>
                            <div class="col-md-4">
                                <label for="smoking_status" class="form-label">吸烟状态</label>
                                <select class="form-select" id="smoking_status" name="smoking_status" required>
                                    <option value="">请选择</option>
                                    <option value="never smoked">从不吸烟</option>
                                    <option value="formerly smoked">过去吸烟</option>
                                    <option value="smokes">吸烟</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="resting_bp" class="form-label">静息血压 (mmHg)</label>
                                <input type="number" class="form-control" id="resting_bp" name="resting_bp" min="80" max="220">
                            </div>
                        </div>
                    </div>
                    
                    <!-- 肝脏相关指标 -->
                    <div class="form-section">
                        <h4><i class="fas fa-pills"></i> 肝脏指标</h4>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="ascites" class="form-label">腹水</label>
                                <select class="form-select" id="ascites" name="ascites">
                                    <option value="">请选择</option>
                                    <option value="N">否</option>
                                    <option value="Y">是</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="hepatomegaly" class="form-label">肝肿大</label>
                                <select class="form-select" id="hepatomegaly" name="hepatomegaly">
                                    <option value="">请选择</option>
                                    <option value="N">否</option>
                                    <option value="Y">是</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="spiders" class="form-label">蜘蛛痣</label>
                                <select class="form-select" id="spiders" name="spiders">
                                    <option value="">请选择</option>
                                    <option value="N">否</option>
                                    <option value="Y">是</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="bilirubin" class="form-label">胆红素 (mg/dL)</label>
                                <input type="number" class="form-control" id="bilirubin" name="bilirubin" min="0" max="30" step="0.1">
                            </div>
                            <div class="col-md-4">
                                <label for="albumin" class="form-label">白蛋白 (g/dL)</label>
                                <input type="number" class="form-control" id="albumin" name="albumin" min="1" max="6" step="0.01">
                            </div>
                            <div class="col-md-4">
                                <label for="sgot" class="form-label">SGOT (IU/L)</label>
                                <input type="number" class="form-control" id="sgot" name="sgot" min="0" max="500">
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <button type="submit" class="btn btn-primary">进行多疾病风险预测</button>
                        <button type="reset" class="btn btn-secondary ms-2">重置</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- 底部导航按钮 -->
    <div class="action-button-container">
        <a href="/predict" class="action-button">
            <i class="fas fa-heartbeat"></i> 进入单一疾病预测
        </a>
    </div>

    <!-- 模型说明 -->
    <div class="row mt-5 content-section">
        <div class="col-md-12 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h3 class="card-title mb-0">多疾病风险预测模型说明</h3>
                </div>
                <div class="card-body">
                    <p>本多疾病风险预测模型采用了先进的机器学习技术，通过分析三种疾病的共同特征和各自特征，建立了多维风险评估体系。主要特点包括：</p>
                    <ul>
                        <li><strong>疾病相关性分析：</strong>考虑中风、心脏病和肝硬化之间的相互影响和共病机制</li>
                        <li><strong>综合风险评分：</strong>计算单一疾病风险以及多疾病组合的联合风险</li>
                        <li><strong>数据驱动决策：</strong>基于大量临床数据训练，提供数据支持的风险预测</li>
                        <li><strong>个性化预测：</strong>根据个人健康特征提供定制化的风险评估</li>
                    </ul>
                    <p class="mt-3">模型采用贝叶斯概率框架，结合条件概率和相关性分析，计算出不同疾病组合的风险概率，为用户提供全面的健康风险画像。</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 添加表单处理
    document.getElementById('multi-disease-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // 显示加载状态
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerText;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 预测中...';
        
        // 收集表单数据
        const formData = new FormData(this);
        
        // 发送AJAX请求
        fetch('/multi-predict', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('网络响应错误');
            }
            return response.json();
        })
        .then(data => {
            // 恢复按钮状态
            submitBtn.disabled = false;
            submitBtn.innerText = originalText;
            
            // 显示预测结果
            showMultiPredictionResult(data);
        })
        .catch(error => {
            // 恢复按钮状态
            submitBtn.disabled = false;
            submitBtn.innerText = originalText;
            
            // 显示错误信息
            showError(error.message);
        });
    });
    
    // 显示多疾病预测结果
    function showMultiPredictionResult(data) {
        const resultContainer = document.getElementById('prediction-result');
        const resultContent = document.getElementById('result-content');
        
        if (data.error) {
            showError(data.error);
            return;
        }
        
        // 清空之前的结果
        resultContent.innerHTML = '';
        
        // 获取概率数据
        const probs = data.probabilities;
        
        // 创建结果HTML
        let html = `
            <div class="text-center mb-4">
                <h3>综合风险评估结果</h3>
                <p class="lead">基于您提供的健康数据，系统分析了多种疾病组合的风险概率</p>
            </div>
            
            <div class="row">
                <div class="col-md-7">
                    <h4 class="mb-3">疾病组合风险概率</h4>
                    <div class="risk-combinations">
        `;
        
        // 添加单一疾病风险
        html += createProbabilityItem('中风风险', probs.stroke * 100, 'brain', 'primary');
        html += createProbabilityItem('心脏病风险', probs.heart * 100, 'heartbeat', 'danger');
        html += createProbabilityItem('肝硬化风险', probs.cirrhosis * 100, 'pills', 'warning');
        
        // 添加双疾病风险
        html += `<hr><h5 class="mt-4">双疾病组合风险</h5>`;
        html += createProbabilityItem('中风和心脏病', probs.stroke_heart * 100, 'stethoscope', 'danger');
        html += createProbabilityItem('中风和肝硬化', probs.stroke_cirrhosis * 100, 'procedures', 'warning');
        html += createProbabilityItem('心脏病和肝硬化', probs.heart_cirrhosis * 100, 'hospital', 'warning');
        
        // 添加三疾病风险
        html += `<hr><h5 class="mt-4">三疾病组合风险</h5>`;
        html += createProbabilityItem('同时患三种疾病', probs.all_three * 100, 'disease', 'dark');
        
        // 健康风险
        html += `<hr>`;
        html += createProbabilityItem('健康（无疾病）', probs.none * 100, 'heart', 'success');
        
        html += `
                    </div>
                </div>
                <div class="col-md-5">
                    <h4 class="mb-3">风险分布图</h4>
                    <div class="chart-container">
                        <canvas id="riskChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="alert alert-info mt-4">
                <h5><i class="fas fa-info-circle"></i> 风险解读</h5>
                <p>该结果显示了您患单一疾病以及多种疾病组合的概率。数值越高表示风险越大，您可以重点关注风险值较高的疾病。</p>
                <p>请注意：此风险预测基于您提供的有限数据，仅供参考，不能替代专业医疗诊断。如有健康问题，请咨询医生。</p>
            </div>
        `;
        
        // 填充结果内容
        resultContent.innerHTML = html;
        
        // 显示结果容器
        resultContainer.style.display = 'block';
        
        // 滚动到结果位置
        setTimeout(() => {
            resultContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            // 初始化图表
            initRiskChart(probs);
        }, 100);
    }
    
    // 创建单个概率项HTML
    function createProbabilityItem(label, probability, icon, colorClass) {
        // 概率范围限制在0-100之间
        probability = Math.max(0, Math.min(100, probability));
        
        // 根据概率值确定风险等级
        let riskLevel = probability < 20 ? '低风险' : 
                        probability < 50 ? '中等风险' : '高风险';
        
        return `
            <div class="probability-item">
                <div class="d-flex justify-content-between align-items-center">
                    <span class="combo-item"><i class="fas fa-${icon} disease-icon text-${colorClass}"></i> ${label}</span>
                    <span class="badge bg-${colorClass}">${probability.toFixed(2)}%</span>
                </div>
                <div class="progress probability-bar">
                    <div class="progress-bar bg-${colorClass}" role="progressbar" style="width: ${probability}%" 
                         aria-valuenow="${probability}" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <div class="text-end mt-1">
                    <small class="text-muted">${riskLevel}</small>
                </div>
            </div>
        `;
    }
    
    // 初始化风险分布图表
    function initRiskChart(probs) {
        const ctx = document.getElementById('riskChart').getContext('2d');
        
        // 准备数据
        const chartData = {
            labels: ['无疾病', '仅中风', '仅心脏病', '仅肝硬化', '中风+心脏病', '中风+肝硬化', '心脏病+肝硬化', '三种疾病'],
            datasets: [{
                label: '风险概率 (%)',
                data: [
                    probs.none * 100,
                    probs.stroke_only * 100,
                    probs.heart_only * 100,
                    probs.cirrhosis_only * 100,
                    probs.stroke_heart * 100,
                    probs.stroke_cirrhosis * 100,
                    probs.heart_cirrhosis * 100,
                    probs.all_three * 100
                ],
                backgroundColor: [
                    'rgba(40, 167, 69, 0.7)',  // 无疾病 - 绿色
                    'rgba(13, 110, 253, 0.7)', // 中风 - 蓝色
                    'rgba(220, 53, 69, 0.7)',  // 心脏病 - 红色
                    'rgba(255, 193, 7, 0.7)',  // 肝硬化 - 黄色
                    'rgba(111, 66, 193, 0.7)', // 中风+心脏病 - 紫色
                    'rgba(23, 162, 184, 0.7)', // 中风+肝硬化 - 青色
                    'rgba(253, 126, 20, 0.7)', // 心脏病+肝硬化 - 橙色
                    'rgba(52, 58, 64, 0.7)'    // 三种疾病 - 深灰色
                ],
                borderWidth: 1
            }]
        };
        
        // 创建图表
        const riskChart = new Chart(ctx, {
            type: 'bar',
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.raw.toFixed(2) + '%';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '概率 (%)'
                        },
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    },
                    x: {
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    }
                }
            }
        });
    }
    
    // 显示错误信息
    function showError(message) {
        const resultContainer = document.getElementById('prediction-result');
        const resultContent = document.getElementById('result-content');
        
        resultContent.innerHTML = `
            <div class="alert alert-danger">
                <h4><i class="fas fa-exclamation-triangle"></i> 出错了</h4>
                <p>很抱歉，预测过程中遇到问题：${message}</p>
                <p>请检查您的输入数据并重试。</p>
            </div>
        `;
        
        resultContainer.style.display = 'block';
        resultContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
});
</script>

<!-- 底部导航按钮 -->
<div class="action-button-container">
    <a href="/predict" class="action-button">
        <i class="fas fa-heartbeat"></i> 进入单一疾病预测
    </a>
</div>
{% endblock %} 