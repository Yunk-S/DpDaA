<div align="center">

**语言版本 / Language Version**

[English](./README_EN.md) | **中文**

</div>

---

# 疾病预测与大数据分析系统

基于机器学习和深度学习的中风、心脏病和肝硬化预测系统，提供数据分析、风险预测和健康管理建议。

## 项目结构

```
├── app.py                        # Web应用主程序
├── main.py                       # 系统入口程序
├── data_preprocessing.py         # 数据预处理模块
├── model_training.py             # 模型训练模块
├── model_calibration.py          # 模型校准模块
├── model_utilities.py            # 模型工具库（指标生成、图表生成）
├── train_deep_learning_models.py # 深度学习模型训练模块
├── visualization.py              # 数据可视化模块
├── chart_generator.py            # 图表生成工具
├── generate_metrics.py           # 模型指标生成工具
├── multi_disease_model.py        # 多疾病混合预测模型
├── predict.py                    # 命令行模型预测模块
├── predict_cmd.bat               # 交互式预测批处理文件
├── run.bat                       # 系统运行启动批处理文件
├── static/                       # 静态资源目录
│   ├── style.css                 # 样式表
│   ├── script.js                 # JavaScript脚本
│   └── images/                   # 图片资源
├── templates/                    # HTML模板
│   ├── index.html                # 首页
│   ├── data_analysis.html        # 数据分析页
│   ├── predict.html              # 预测页面
│   ├── multi_disease.html        # 多疾病关联分析页面
│   └── ...                       # 其他页面
├── output/                       # 输出目录
│   ├── models/                   # 保存训练好的模型
│   │   ├── calibrators/          # 保存校准器模型
│   ├── figures/                  # 生成的图表
│   └── processed_data/           # 处理后的数据
├── requirements.txt              # 项目依赖包列表
└── *.csv                         # 原始数据集（stroke.csv, heart.csv, cirrhosis.csv）
```

## 安装与运行

### 环境要求

- Python 3.8+
- 相关依赖包（详见requirements.txt）

### 安装步骤

1. 创建并激活虚拟环境
   ```
   python -m venv venv
   # Windows
   venv\Scripts\activate
   # Linux/Mac
   source venv/bin/activate
   ```

2. 安装依赖包
   ```
   pip install -r requirements.txt
   ```

   如果在中国大陆地区安装速度较慢，可以使用清华镜像源：
   ```
   pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple --trusted-host pypi.tuna.tsinghua.edu.cn
   ```

### 运行系统

#### 方式一：使用批处理文件（Windows）

直接运行 `run.bat` 批处理文件，按提示操作：
```
run.bat
```

运行时会按以下顺序提示：
1. 是否创建/使用虚拟环境（推荐选择Y）
   - 如果选择Y且不存在虚拟环境，将创建新的虚拟环境并自动激活
   - 如果选择Y且已存在虚拟环境，将直接激活已有的虚拟环境
   - 如果选择N，将使用系统Python环境
2. 是否安装依赖包
   - 首次使用时需要安装依赖
   - 可选择使用默认安装源或清华镜像源（中国大陆推荐）
3. 选择功能模式：
   1. 运行完整的分析和预测流程
   2. 只运行数据预处理
   3. 只运行数据可视化
   4. 只运行模型训练
   5. 只运行图表和指标生成
   6. 只运行Web应用
   7. 直接执行main.py（所有步骤）
   8. 退出

**注意：** 
- 选项1和选项7实际功能相同，都会执行完整流程。选择任一即可。
- 使用虚拟环境可以避免依赖冲突问题，特别推荐新用户使用。
- 程序结束后，如果使用了虚拟环境，需要手动输入`deactivate`命令退出虚拟环境。

#### 方式二：使用Python命令

运行完整流程（数据预处理、可视化、模型训练、图表指标生成和Web应用）：
```
python main.py --all
```

或者使用不同的参数单独运行特定功能：
- `--preprocess`：只运行数据预处理
- `--visualize`：只运行数据可视化
- `--train`：只运行模型训练
- `--generate`：只运行图表和指标生成
- `--webapp`：只运行Web应用

示例：只启动Web应用
```
python main.py --webapp
```

#### 方式三：使用命令行预测工具 注意！！先使用这个进行预测！！！

1. 使用命令行工具直接预测：
```
python predict.py [disease_type] [param1=value1] [param2=value2] ...
```

例如，预测中风风险：
```
python predict.py stroke age=60 gender=Male hypertension=1 heart_disease=0 avg_glucose_level=120 bmi=28 smoking_status="formerly smoked"
```

2. 或者使用交互式批处理文件进行预测：
```
predict_cmd.bat
```
按提示选择疾病类型并输入相关健康指标。

**参数说明：**
- `disease_type`：疾病类型，可选值有 stroke(中风)、heart(心脏病)、cirrhosis(肝硬化)和multi(多疾病)
- 后续参数为健康指标，格式为 参数名=参数值

#### 交互式预测工具使用说明

`predict_cmd.bat` 是一个交互式的命令行预测工具，提供英文界面进行疾病风险预测。使用步骤：

1. 运行 `predict_cmd.bat` 文件
2. 根据提示选择要预测的疾病类型（1-4之间的数字）
   - 1: 中风预测 (Stroke prediction)
   - 2: 心脏病预测 (Heart disease prediction)
   - 3: 肝硬化预测 (Cirrhosis prediction)
   - 4: 多疾病混合预测 (Multi-disease prediction)
3. 根据提示逐步输入健康指标数据
4. 系统将显示预测结果，包括风险概率和等级

该工具特别适合在Web应用无法正常运行时使用，或者希望快速获取预测结果而无需启动完整Web界面的情况。

## Web应用使用说明 

1. 运行Web应用后，系统将自动在浏览器中打开首页（http://localhost:5000）
2. 在首页可查看系统简介和三种疾病的基本信息
3. 导航栏提供以下功能入口：
   - **数据分析**：查看三种疾病数据的分布、相关性和特征重要性
   - **模型性能**：查看各预测模型的性能指标和评估结果
   - **疾病预测**：输入个人健康指标，获取疾病风险预测和健康建议  （前后端连接bug，请使用predict_cmd.bat进行预测）
   - **多疾病关联**：查看三种疾病之间的关联性分析和综合风险评估

### 单一疾病预测功能
1. 点击顶部导航栏的"疾病预测"下拉菜单，选择"单一疾病预测"
2. 在预测页面，可以选择中风、心脏病或肝硬化三种疾病之一进行风险预测
3. 填写相应的健康指标表单，点击"预测风险"按钮
4. 系统将显示预测结果，包括风险概率、风险等级和健康建议

### 多疾病联合预测功能
1. 点击顶部导航栏的"疾病预测"下拉菜单，选择"多疾病联合预测"
2. 填写综合健康指标表单，包括基本信息、生活方式和临床指标
3. 点击"综合预测"按钮
4. 系统将显示三种疾病的单独风险以及多种疾病组合的联合风险概率

## 项目概述

本项目旨在构建一个综合性疾病预测与分析系统，通过对中风、心脏病和肝硬化三种常见重大疾病的数据进行深入分析，建立预测模型，并提供可视化界面展示结果和健康管理建议。系统采用多种先进的机器学习和深度学习算法，结合医学领域知识，实现高精度的疾病风险预测。

### 初始思路

项目的设计思路基于以下几点：
1. **多疾病整合分析**：不同于传统的单一疾病预测系统，本项目同时处理三种相关性较高的重大疾病，探索它们之间的关联性和共同风险因素
2. **数据驱动决策**：通过大量真实医疗数据的分析，提取有价值的特征和模式，辅助医疗决策
3. **模型集成与优化**：结合多种机器学习算法的优势，采用集成学习和模型融合技术提高预测准确性
4. **可解释性分析**：使用SHAP值和特征重要性分析，提供模型预测结果的可解释性
5. **用户友好界面**：设计直观的Web界面，使医疗专业人员和普通用户都能便捷使用系统

## 功能特点

- **多疾病预测**：针对中风、心脏病和肝硬化三种重大疾病进行风险预测
- **数据可视化**：直观展示数据分布、特征相关性和预测结果
- **风险评估**：提供个性化的健康风险评分和预防建议
- **交互式界面**：用户友好的Web界面，支持实时预测和结果展示
- **多疾病关联分析**：分析不同疾病之间的关联性和共病风险
- **年龄与疾病关系分析**：展示不同年龄段的疾病发病率变化趋势
- **错误恢复机制**：当模型加载失败时，系统会自动使用备用模型或模拟数据进行预测，确保用户体验不受影响

## 技术架构

- **前端**：HTML5、CSS3、JavaScript、Bootstrap 5、Chart.js
- **后端**：Python、Flask
- **数据处理**：Pandas、NumPy、Scikit-learn
- **可视化**：Matplotlib、Seaborn、Plotly
- **机器学习模型**：
  - 传统机器学习算法（随机森林、XGBoost、LightGBM、CatBoost、SVM等）
  - 深度学习模型（DNN、注意力机制网络）
  - 集成学习（投票、堆叠、混合融合）
- **模型可解释性**：SHAP值分析

## 多疾病混合预测模型详解

### 模型架构

多疾病混合预测模型（`MultiDiseasePredictor`类）是系统的核心组件之一，实现了以下功能：

1. **模型加载与回退机制**：
   - 尝试加载已训练的单病种预测模型
   - 当模型加载失败时，自动创建备用模型（RandomForest）
   - 提供模拟数据预测功能，确保系统在任何情况下都能正常运行

2. **单病种风险预测**：
   - 中风预测：基于年龄、性别、高血压等特征预测中风风险
   - 心脏病预测：基于胸痛类型、血压、胆固醇等特征预测心脏病风险
   - 肝硬化预测：基于生化指标预测肝硬化风险或分期

3. **多疾病联合预测**：
   - 独立预测：计算各疾病独立发生的概率
   - 联合概率：计算多种疾病组合的联合概率
   - 考虑相关性：通过相关系数调整联合概率，更符合实际医学情况

### 数学原理

1. **多任务学习框架**：
   系统采用多任务学习框架，通过共享底层特征表示，同时学习多个相关任务（疾病预测）。

   数学表示：

   共享特征提取层：
   $$\mathbf{h} = f_{\text{shared}}(\mathbf{x}; \theta_s)$$

   任务特定输出层：
   $$\hat{y}^{(k)} = f_{\text{task}_k}(\mathbf{h}; \theta_k)$$

2. **联合概率计算**：
   对于疾病A、B、C的独立概率分别为 $P(A)$、$P(B)$、$P(C)$，系统计算以下联合概率：
   
   - 单一疾病：
   ```math
   P(A)(1-P(B))(1-P(C))
   ```
   
   - 两种疾病：
   ```math
   P(A)P(B)(1-P(C))
   ```
   
   - 三种疾病：
   ```math
   P(A)P(B)P(C)
   ```
   
   - 无疾病：
   ```math
   (1-P(A))(1-P(B))(1-P(C))
   ```

3. **相关性调整**：
   系统使用相关系数调整联合概率，计算考虑相关性的联合概率：

   $$P(A,B) = P(A)P(B) + \text{corr}_{AB} \cdot \min(P(A), P(B)) \cdot (1 - \max(P(A), P(B)))$$
   
   
   其中 $\text{corr}_{AB}$ 是疾病A和B之间的相关系数。

4. **注意力机制**：
   深度学习模型中使用注意力机制，增强模型对重要特征的关注：

   $$\alpha_i = \text{Attention}(h_i)$$
   $$h'_i = h_i \cdot \alpha_i$$
   
   其中 $\alpha_i$ 是注意力权重，$h_i$ 是特征表示。

### 模型优化技术

1. **知识蒸馏**：
   - 教师模型：复杂的深度神经网络或集成模型
   - 学生模型：轻量级模型，通过学习教师模型的"软标签"提高性能
   - 蒸馏损失：
   ```math
   \mathcal{L}_{\text{distill}} = \alpha \cdot \mathcal{L}_{\text{CE}}(y, \hat{y}_{\text{student}}) + (1-\alpha) \cdot \mathcal{L}_{\text{KL}}(\hat{y}_{\text{teacher}}, \hat{y}_{\text{student}})
   ```

2. **集成学习**：
   - 投票集成：多个基础模型通过投票或平均方式得到最终预测
   - 堆叠集成：使用元学习器整合基础模型的预测结果
   - 混合融合：结合传统机器学习和深度学习模型的优势

3. **协同正则化**：
   鼓励不同任务的参数共享信息，促使模型学习疾病间的共病模式：
   
   ```math
   \mathcal{L}_{\text{reg}} = \lambda \cdot \sum_{i,j} \| \theta_i - \theta_j \|_2^2
   ```

## 使用的数学知识和模型技术

### 数据预处理技术
- **缺失值处理**：迭代插补法(IterativeImputer)、KNN插补法、均值/中位数填充
- **异常值检测**：IQR方法、Z-score方法、隔离森林
- **特征工程**：特征选择、特征交互、多项式特征、风险评分计算
- **数据标准化**：Z-score标准化、Min-Max缩放
- **类别不平衡处理**：SMOTE过采样、类别权重调整

### 机器学习算法
- **分类算法**：逻辑回归、随机森林、梯度提升树、XGBoost、LightGBM、CatBoost、SVM
- **回归算法**：线性回归、岭回归、LASSO回归、弹性网络、SVR、随机森林回归、梯度提升回归
- **集成学习**：
  - 投票集成：结合多个基础模型的预测结果，通过投票或平均方式得到最终预测
  - 堆叠集成：使用元学习器整合基础模型的预测结果
  - 混合融合：结合不同类型模型的优势，如传统机器学习和深度学习模型的融合

### 深度学习技术
- **深度神经网络(DNN)**：多层感知机结构，用于复杂特征学习
- **注意力机制**：在神经网络中引入注意力层，关注重要特征
- **批归一化**：加速训练过程并提高模型稳定性
- **Dropout正则化**：防止过拟合
- **知识蒸馏**：从复杂模型向简单模型迁移知识

### 模型评估与优化
- **交叉验证**：K折交叉验证、分层K折交叉验证
- **超参数优化**：网格搜索、随机搜索
- **性能指标**：
  - 分类任务：准确率、精确率、召回率、F1分数、AUC-ROC
  - 回归任务：MSE、RMSE、MAE、R²

### 可解释性分析
- **SHAP值分析**：解释模型预测中各特征的贡献度
- **特征重要性分析**：识别对预测结果影响最大的特征
- **部分依赖图**：展示特定特征与预测结果的关系

## 数据集说明

项目使用以下三个数据集：

1. **中风数据集 (stroke.csv)**
   - 特征：年龄、性别、高血压、心脏病史、婚姻状况、工作类型、居住类型、平均血糖水平、BMI、吸烟状态
   - 目标变量：是否发生中风（二分类）
   - 样本量：约5,110条记录
   - 特点：类别不平衡，缺失值主要集中在BMI特征

2. **心脏病数据集 (heart.csv)**
   - 特征：年龄、性别、胸痛类型、静息血压、胆固醇、空腹血糖、心电图结果、最大心率、心绞痛、ST段抑制、ST斜率
   - 目标变量：是否患有心脏病（二分类）
   - 样本量：约918条记录
   - 特点：特征组合复杂，多种类型的胸痛和心电图结果需要专门编码

3. **肝硬化数据集 (cirrhosis.csv)**
   - 特征：年龄、性别、胆红素、胆固醇、白蛋白、铜、碱性磷酸酶、SGOT、甘油三酯、血小板、凝血酶原时间等
   - 目标变量：肝硬化分期（1-4期，回归任务）
   - 样本量：约418条记录
   - 特点：目标变量为连续值，需要使用回归模型；存在多个生化指标

### 多疾病关联分析功能

多疾病关联分析页面提供了以下几个关键部分：
1. **疾病间关联概述**：介绍三种疾病之间的关联性和共同病理机制
2. **性别与疾病关系对比**：展示不同性别在三种疾病上的风险差异
3. **年龄分布比较**：通过小提琴图展示三种疾病患者的年龄分布特点
4. **年龄与疾病发病率关系**：展示不同年龄段人群中三种疾病的发病率变化趋势
5. **共病风险因素分析**：通过表格和雷达图展示影响多种疾病的共同风险因素
6. **多病预测模型与综合风险评估**：介绍多目标学习方法和综合风险评分系统
7. **预防建议与健康管理**：提供针对多种疾病的综合预防和健康管理建议

## 系统性能与局限性

### 性能指标
- 中风预测：准确率约92.3%，AUC约0.89
- 心脏病预测：准确率约88.5%，AUC约0.91
- 肝硬化分期：R²约0.28，RMSE约0.71

### 局限性
1. 数据集规模有限，可能影响模型泛化能力
2. 缺乏时序数据，无法进行疾病进展预测
3. 未整合基因组学数据，限制了个性化医疗的潜力
4. 模型可解释性仍有提升空间

## 错误处理与回退机制

系统实现了多层次的错误处理和回退机制，确保在各种情况下都能正常运行：

1. **模型加载失败处理**：
   - 当预训练模型无法加载时，系统会自动创建简单的替代模型
   - 对于分类任务（中风、心脏病）使用RandomForestClassifier
   - 对于回归任务（肝硬化）使用RandomForestRegressor

2. **预测错误处理**：
   - 捕获预测过程中的异常，返回默认概率值
   - 在前端显示模拟数据使用提示，确保用户了解结果可靠性

3. **Web应用错误处理**：
   - 实现全局异常处理，捕获并记录错误
   - 提供用户友好的错误页面，而不是直接显示技术错误信息

   ### 模型校准功能

为了解决预测概率偏低的问题，特别是对于高风险人群，系统新增了模型校准功能：

1. **概率校准技术**：
   - Platt Scaling（逻辑回归校准）：使用逻辑回归对原始预测概率进行校准
   - 等渗回归（Isotonic Regression）：使用非参数方法对概率进行校准，更加灵活
   - 分段样条校准：针对不同概率区间使用不同校准策略

2. **自适应校准策略**：
   - 根据风险水平自动选择最佳校准方法
   - 低风险人群使用温和校准
   - 高风险人群使用更激进的校准策略

3. **校准评估指标**：
   - Brier分数评估：衡量概率预测的准确性
   - 对数损失评估：衡量概率预测的不确定性
   - 校准曲线可视化：直观展示校准前后的效果

校准后的模型显著提高了预测准确性，特别是对于高风险人群，使预测结果更符合临床实际情况。

### 运行校准功能

可以通过以下方式运行模型校准：

1. 使用命令行参数：
   ```
   python main.py --calibrate
   ```

2. 在完整流程中自动运行：
   ```
   python main.py --all
   ```

3. 使用批处理文件，选择相应功能：
   ```
   run.bat
   ```

### 校准原理

模型校准基于以下数学原理：

1. **Platt Scaling**：使用逻辑回归将原始预测分数映射到校准概率

   数学表达式：
   $$P(y=1|s) = \sigma(As + B)$$
   
   其中 $s$ 是原始分数，$A$ 和 $B$ 是参数，$\sigma$ 是sigmoid函数

2. **等渗回归**：使用分段常数函数进行非参数校准
   - 保持概率单调性，同时最小化均方误差

3. **自适应校准**：
   - 对于低风险样本(p < 0.3)：使用Platt Scaling
   - 对于高风险样本(p ≥ 0.3)：使用等渗回归或样条校准

4. **分段样条校准**：
   - 低概率区域 $(p < 0.2)$：
   $$p' = p \times 1.2$$

   - 中等概率区域 $(0.2 \leq p < 0.5)$：
   $$p' = 0.24 + (p - 0.2) \times 1.5$$

   - 高概率区域 $(p \geq 0.5)$：
   $$p' = 0.69 + (p - 0.5) \times 1.8$$

## 项目打包说明

### 必要文件和目录

打包项目时请包含以下内容：
1. 所有Python源代码文件（*.py）
2. 数据集文件（stroke.csv, heart.csv, cirrhosis.csv）
3. static目录（包含静态资源）
4. templates目录（包含HTML模板）
5. requirements.txt（依赖包列表）
6. README.md（本说明文件）
7. run.bat批处理脚本

### 可排除的目录

打包时可以排除以下内容：
1. __pycache__目录（Python缓存文件）
2. .idea目录（IDE配置文件）
3. .venv或venv目录（Python虚拟环境）
4. catboost_info目录（CatBoost临时文件）
5. app.log（应用日志文件）
6. output目录（可在运行时自动生成）

## 贡献者

- 石韫琨
- 曾子航
